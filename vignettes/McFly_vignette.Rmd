---
title: "McFly"
author: "Gabriel Nakamura and Leandro Duarte"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{mcfly - an R package to access the effects of environmental niche selection on species     diversity in metacommunities}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

#Introduction to McFly package
Mcfly package was designed to access the effects of stabilizing selection along the macroevolutionary dynamics of a given lineage on niche-based species sorting accross sets of local communities, and its consequence for species diversity gradients.
We will demonstrate in this vignette all the steps needed to carry on an analysis using the mcfly function. First of all, we need to install and read the McFly package

```{r setup, eval= FALSE, echo= TRUE}
devtools::install_github("GabrielNakamura/McFly")
library(McFly)
```

##Data: Furnaridae family
We will run all the analysis using occurrence of avian species from Furnaridae family. This data is a part of the mcfly package, to read it type:
```{r readData, eval=FALSE}
data("Furnaridae")
```
Furnaridae comprises the occurence of 223 species of Furnaridae family distributed through the entire Neotropical region. The phylogenetic hypothesis used in this analysis was obtained from [BirdTree](https://birdtree.org/) and are presented in phylo_Furnaridae object.
```{r readPhy, eval=FALSE}
data("phylo_Furnaridae")
```
We also need an environmental descriptor to run mcfly function. In this example we will use an synthetic environmental descriptor obtained from a principal component analysis performed using four climatic variables (mean anual temperature, temperature sazonality, mean anual precipitation and precipitation sazonality). 
```{r envdata, eval= FALSE}
data("envir")
```

##Data proccessing 
Due to computational convenience and since the analysis is sensitive to the representativeness of species pool on phylogenetic hypothesis used, we first find for subfamilies in Furnaridae phylogeny to select that presented a number of species that present a sactisfatory number of occurences in the community data, at the same time that do not make the analysis very time consuming.
```{r phylo_process, eval= FALSE}
sub.tree<- ape::subtrees(phylo_Furnaridae) #subseting phylogeny to family level
n.nodes<-length(sub.tree)
nspp.nodes<-matrix(NA,n.nodes,1)
for(i in 1:n.nodes){
  nspp.nodes[i,]<-sub.tree[[i]]$Ntip #number of species in each sub-family
}

dim.comm.subset<-matrix(NA,nspp.nodes,2)
for(j in 1:n.nodes){
  sub.phy<-sub.tree[[j]]
  comm.sub.phy<-Furnaridae[,sub.phy$tip.label]
  zero.row<-which(rowSums(comm.sub.phy)==0)
  comm.subset<-comm.sub.phy[-zero.row,]
  dim.comm.subset[j,]<-dim(comm.subset) #size of all communities for each subfamily
}

```
We choose Synallaxinae subfamily, that presented nine species distributed through 649 communities. The occurence of these species was extracted from community data. We also filter environmental variables and coordinates to match with occurences of Synallaxinae species in community data
```{r comm_procces, eval= FALSE}
plot(sub.tree[[49]]) #Synallaxinae subfamily
sub.phy<- sub.tree[[49]]
comm.sub.phy<- Furnaridae[, sub.tree[[49]]$tip.label] #selecting only sites that present occurences of species from Synallaxinae subfamily
zero.row<- which(rowSums(comm.sub.phy) == 0)
comm.subset<- comm.sub.phy[-zero.row, ] #community matrix with occurrence of Synalaxynae species
coords.subset<- as.matrix(envir[rownames(comm.subset), c(1,2)])
```
##Seting parameters to enter in mcfly function
We need to define parameters to enter in mcfly function. sigma, that represents environmental niche breadth, was set as being the standard deviation of environmental variable. The environmental variable choose was latitude, assuming that this represent a latent variable that summarizes the variation in a set of niche dimensions of species. root.value, that comprises the trait value at the root of phylogenetic tree, was set as being the mean value of niche dimension of species and theta, that represent the optimun value of niche position for the species was set as being the value derived from the predicted relationship among diversity values and the environmental variable.
```{r choos_params, eval=FALSE}
env.subset<-envir[rownames(comm.subset),]
envir<- scales::rescale(as.matrix(env.subset$Lat),c(1,100)) #scaling the environmental variable to vary between 1 and 100
sigma<- sd(envir) #standard deviation of environmental variable
root.value<- mean(envir) #mean value
div<- vegan::renyi(comm.subset,scales=1) #diversity metric
mod<- lm(div~envir) #linear model
pred<- predict.lm(mod) #predicted relationship among diversity and environmental variable
ED<- cbind(envir,pred)
theta<- ED[which.max(pred),1] #optimun at the midle of niche space
```
Finally, we choose the alpha values by relating different alpha values with their K values. This is the same procedure used in Duarte et al. (XXXX) to choose the alpha parameters evaluated for Sigmodontinae species. Four alpha values was selected
```{r choos_alpha, eval= FALSE}
OU.alpha<- c(0,0.05,0.25,1)
```

Finally, we choose the number of runs, that indicate the number of times that the simulation will be repeated and the number of computer cores to perform the analysis. Here we set the number of cores as being the total number of cores minus 1 
```{r nCores_runs, eval= FALSE}
ncores<- parallel::detectCores() - 1
```
Since the main objective of this example is to demonstrate how we can obtain the alpha parameters that present the higher support in generate the diversity patterns, we decided to set the W.r parameter as 0, that assumes no dispersion limitation for species through space in the simulation procedure (a panmitic community). Other scenarios of dispersal limitation can be used.

Finally, we run mcfly function
```{r mcfly_run, eval= FALSE}
test.synallaxinae<- mcfly(comm= comm.subset, subset= FALSE, occurrence= TRUE, env= envir, site.coords= coords.subset, tree= sub.phy, OU.alpha= OU.alpha, sigma= sigma, theta= theta, root.value= root.value, runs= 3, ncores= 3, area.m2= 1, m= 0.5, JM= sum(comm.subset), JM.limit= JM,JL= rowSums(comm.subset),nu= 0, speciation.limit= 0, n.timestep= 50,W.r= 0, scenario.ID= "species.sorting", sim.ID= "data", output.dir.path= "OUTPUT_DATA")
```
The output of mcfly function is a list containing the following objects:

